<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPay Savings Shelf Sys</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="./config.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        opay: { DEFAULT: '#00B875', hover: '#00905B', light: '#E5F8F1', bg: '#F2FCF8' }
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px); }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00B875; }
        
        /* Table Cell Alignment */
        td { vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans text-sm">

<div id="app" v-cloak class="h-screen flex flex-col overflow-hidden">

    <div v-if="!configLoaded" class="fixed inset-0 z-50 bg-red-50 flex items-center justify-center p-10">
        <div class="text-center max-w-lg">
            <div class="text-6xl mb-4">âš ï¸</div>
            <h1 class="text-2xl font-bold text-red-700 mb-2">é…ç½®åŠ è½½å¤±è´¥</h1>
            <p class="text-red-600">æ— æ³•è¯»å– <code>window.OPAY_FINANCE_CONFIG</code> æ•°æ®æºã€‚</p>
            <p class="text-gray-500 mt-2 text-xs">è¯·ç¡®ä¿åŒçº§ç›®å½•ä¸‹å­˜åœ¨ config.js æ–‡ä»¶ä¸”æ ¼å¼æ­£ç¡®ã€‚</p>
        </div>
    </div>

    <header class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-opay flex items-center justify-center text-white font-bold text-lg">O</div>
            <span class="font-bold text-lg tracking-tight">OPay <span class="text-opay">Savings Shelf Sys</span></span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center bg-gray-100 rounded px-3 py-1.5 border border-gray-200">
                <span class="text-xs text-gray-500 mr-2 font-bold">å½“å‰è§’è‰²:</span>
                <select v-model="currentRoleCode" class="bg-transparent text-sm font-bold text-gray-700 outline-none cursor-pointer">
                    <option v-for="role in rolesList" :key="role.code" :value="role.code">
                        {{ role.name }}
                    </option>
                </select>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden border flex items-center justify-center font-bold text-gray-500">
                    {{ currentUser?.name ? currentUser.name.charAt(0) : 'U' }}
                </div>
                <div class="text-xs text-gray-500">
                    {{ currentUser?.name || 'User' }}
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-56 bg-white border-r border-gray-200 flex flex-col py-4">
            <nav class="space-y-1 px-2">
                <a href="#" @click.prevent="currentView = 'registry'" :class="navClass('registry')" class="flex items-center px-4 py-2.5 rounded-lg group transition-colors">
                    <span class="mr-3">ğŸ“¦</span> äº§å“ç®¡ç†
                </a>

                <a href="#" @click.prevent="currentView = 'monitor'" :class="navClass('monitor')" class="flex items-center px-4 py-2.5 rounded-lg group transition-colors">
                    <span class="mr-3">ğŸ“Š</span> é¢åº¦ç›‘æ§
                </a>

                <a href="#" v-if="hasPermission('view')" @click.prevent="currentView = 'history'" :class="navClass('history')" class="flex items-center px-4 py-2.5 rounded-lg group transition-colors">
                    <span class="mr-3">ğŸ“‰</span> å†å²åˆ©ç‡å˜æ›´
                </a>
                
                <a href="#" v-if="hasPermission('view')" @click.prevent="currentView = 'params'" :class="navClass('params')" class="flex items-center px-4 py-2.5 rounded-lg group transition-colors">
                    <span class="mr-3">âš™ï¸</span> ç³»ç»Ÿå‚æ•°
                </a>

                <a href="#" v-if="hasPermission('user_manage')" @click.prevent="currentView = 'users'" :class="navClass('users')" class="flex items-center px-4 py-2.5 rounded-lg group transition-colors">
                    <span class="mr-3">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†
                </a>

                <a href="#" v-if="hasPermission('permission_manage')" @click.prevent="currentView = 'permissions'" :class="navClass('permissions')" class="flex items-center px-4 py-2.5 rounded-lg group transition-colors">
                    <span class="mr-3">ğŸ›¡ï¸</span> æƒé™ç®¡ç†
                </a>
            </nav>
        </aside>

        <main class="flex-1 overflow-auto p-6 relative">
            
            <div v-if="currentView === 'registry'" class="space-y-4">
                <div class="bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-end shadow-sm">
                    <div class="flex gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">å“ç±»ç­›é€‰ (Category)</label>
                            <select v-model="filters.category" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-40 focus:border-opay focus:ring-1 focus:ring-opay outline-none">
                                <option value="">å…¨éƒ¨å“ç±»</option>
                                <option v-for="c in categories" :value="c.code">{{ c.name }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">çŠ¶æ€ç­›é€‰ (Status)</label>
                            <select v-model="filters.status" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-40 focus:border-opay focus:ring-1 focus:ring-opay outline-none">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="å¼€æ”¾ä¸­">å¼€æ”¾ä¸­</option>
                                <option value="å·²ä¸Šæ¶å¾…å¼€æ”¾">å·²ä¸Šæ¶å¾…å¼€æ”¾</option>
                                <option value="è‰ç¨¿">è‰ç¨¿</option>
                                <option value="ä¸Šæ¶å®¡æ‰¹ä¸­">ä¸Šæ¶å®¡æ‰¹ä¸­</option>
                                <option value="ä¿®æ”¹å®¡æ‰¹ä¸­">ä¿®æ”¹å®¡æ‰¹ä¸­</option>
                                <option value="ä¸‹æ¶å®¡æ‰¹ä¸­">ä¸‹æ¶å®¡æ‰¹ä¸­</option>
                                <option value="å·²ä¸‹æ¶">å·²ä¸‹æ¶</option>
                                <option value="å·²è¿‡æœŸ">å·²è¿‡æœŸ</option>
                                <option value="å·²å”®ç½„">å·²å”®ç½„</option>
                            </select>
                        </div>
                    </div>
                    
                    <button v-if="hasPermission('add')" @click="initCreateProduct" class="bg-opay hover:bg-opay-hover text-white px-4 py-2 rounded shadow font-bold flex items-center transition">
                        <span class="mr-1 text-lg">+</span> æ–°å¢äº§å“
                    </button>
                </div>

                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-48">Product Name / Code</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-24">Category</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-48">Rate (APY)</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-32">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-40">Modified Info</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            <tr v-for="p in filteredProducts" :key="p.product_code" class="hover:bg-gray-50">
                                <td class="px-4 py-4">
                                    <div class="font-bold text-gray-900 text-sm truncate" :title="p.name">{{ p.name }}</div>
                                    <div class="text-xs text-gray-500 font-mono">{{ p.product_code }}</div>
                                </td>
                                <td class="px-4 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        {{ p.category_code }}
                                    </span>
                                </td>
                                <td class="px-4 py-4">
                                    <div v-if="p.is_tiered_rate" class="flex flex-col gap-0.5">
                                        <div v-for="(r, idx) in p.rates" :key="idx" class="text-xs text-opay font-bold font-mono whitespace-nowrap">
                                            {{ (r.rate * 100).toFixed(2) }}% 
                                            <span class="text-gray-400 font-normal ml-1">(â‰¥{{ formatMoneyRaw(r.stepMinAmount) }})</span>
                                        </div>
                                    </div>
                                    <div v-else class="text-xs text-opay font-bold font-mono">
                                        {{ p.rates[0] ? (p.rates[0].rate * 100).toFixed(2) + '%' : '-' }}
                                    </div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="flex flex-col gap-1 items-start">
                                        <span :class="statusBadgeClass(getDisplayStatus(p))" class="px-2 py-1 text-xs rounded border font-bold whitespace-nowrap">
                                            {{ getDisplayStatus(p) }}
                                        </span>
                                        <a href="#" v-if="['ä¸Šæ¶å®¡æ‰¹ä¸­', 'ä¿®æ”¹å®¡æ‰¹ä¸­', 'ä¸‹æ¶å®¡æ‰¹ä¸­'].includes(p.status) && hasPermission('audit')" 
                                           @click.prevent="mockFeishuPass(p)"
                                           class="text-[10px] text-blue-600 underline hover:text-blue-800 flex items-center gap-1">
                                           ğŸ”—æ¨¡æ‹Ÿé€šè¿‡
                                        </a>
                                    </div>
                                    <div v-if="p.status === 'å·²ä¸Šæ¶å¾…å¼€æ”¾'" class="text-[10px] text-gray-400 mt-1">
                                        {{ p.sub_start_date }} ç”Ÿæ•ˆ
                                    </div>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-xs text-gray-700">{{ p.update_time || '-' }}</div>
                                    <div class="text-xs text-gray-400">{{ p.operator || '-' }}</div>
                                </td>
                                <td class="px-4 py-4 text-right space-x-2">
                                    <button @click="openModal('view', p)" class="text-gray-500 hover:text-gray-900 font-medium text-xs">è¯¦æƒ…</button>
                                    
                                    <button v-if="canShowEditButton(p)" 
                                            @click="openModal('edit', p)" 
                                            class="text-opay hover:text-opay-hover font-bold text-xs">
                                            ç¼–è¾‘
                                    </button>
                                    
                                    <button v-if="p.status === 'è‰ç¨¿' && hasPermission('add')" 
                                            @click="initiateApproval(p, 'listing')"
                                            class="text-blue-600 hover:text-blue-800 font-bold text-xs">
                                            ä¸Šæ¶
                                    </button>

                                    <button v-if="p.status === 'è‰ç¨¿' && !isStandardProduct(p.product_code) && hasPermission('edit')" 
                                            @click="deleteProduct(p)"
                                            class="text-red-500 hover:text-red-700 font-bold text-xs">
                                            å–æ¶ˆ
                                    </button>

                                    <button v-if="['å¼€æ”¾ä¸­', 'å·²ä¸Šæ¶å¾…å¼€æ”¾', 'å·²å”®ç½„'].includes(getDisplayStatus(p)) && !isStandardProduct(p.product_code) && hasPermission('off_shelf')" 
                                            @click="initiateApproval(p, 'offshelf')"
                                            class="text-red-600 hover:text-red-800 font-bold text-xs border border-red-200 bg-red-50 px-2 py-0.5 rounded">
                                            ä¸‹æ¶
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="currentView === 'monitor'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Fixed Special é¢åº¦ç›‘æ§çœ‹æ¿</h2>
                        <div class="text-xs text-gray-500 mt-1 flex items-center gap-3">
                            <span>æœ€åæ›´æ–°: {{ monitorLastUpdated }}</span>
                            <button @click="refreshMonitor" class="text-opay font-bold hover:underline flex items-center gap-1 active:scale-95 transition-transform">
                                ğŸ”„ åˆ·æ–° (+5% Sales)
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <span class="flex items-center text-xs gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> åœ¨å”®</span>
                        <span class="flex items-center text-xs gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> å¾…å¼€æ”¾</span>
                        <span class="flex items-center text-xs gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> å”®ç½„</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div v-for="item in monitorList" :key="item.product_code" 
                         class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm transition">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-lg text-gray-800">{{ item.name }}</h3>
                                    <span :class="statusBadgeClass(getDisplayStatus(item))" class="text-xs px-2 py-0.5 rounded border">{{ getDisplayStatus(item) }}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 font-mono">Code: {{ item.product_code }}</div>
                                <div class="text-xs text-gray-500 mt-0.5">é”€å”®æœŸ: {{ item.sub_start_date }} ~ {{ item.sub_end_date }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">å½“å‰é”€å”®è¿›åº¦</div>
                                <div class="text-2xl font-bold font-mono" :class="getProgressBarColor(item, true)">
                                    {{ item.progress }}%
                                </div>
                            </div>
                        </div>

                        <div class="relative w-full h-3 bg-gray-100 rounded-full overflow-hidden mb-2">
                            <div class="h-full rounded-full transition-all duration-1000"
                                 :class="getProgressBarColor(item)"
                                 :style="{ width: item.progress + '%' }">
                            </div>
                        </div>

                        <div class="flex justify-between text-xs font-mono text-gray-600">
                            <span>å·²å”®: {{ formatMoney(item.sold_amount) }}</span>
                            <span>æ€»é¢åº¦: {{ formatMoney(item.issue_size) }}</span>
                        </div>
                    </div>
                    <div v-if="monitorList.length === 0" class="text-center py-10 text-gray-400 bg-white rounded border border-dashed">
                        æš‚æ— åœ¨å”®/å¾…å¼€æ”¾çš„ Fixed äº§å“
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'history'" class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-bold text-gray-800">å†å²åˆ©ç‡å˜æ›´è®°å½•</h3>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Change Date</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Details (New Rate)</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Operator</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr v-for="h in globalRateHistory" :key="h.id">
                            <td class="px-6 py-4 text-xs font-mono text-gray-600">{{ h.date }}</td>
                            <td class="px-6 py-4 text-sm font-bold text-gray-800">{{ h.product_name }}</td>
                            <td class="px-6 py-4 text-xs">
                                <span class="bg-gray-100 px-2 py-1 rounded">{{ h.category }}</span>
                            </td>
                            <td class="px-6 py-4 text-xs font-mono text-opay whitespace-pre-wrap">{{ h.rate_info }}</td>
                            <td class="px-6 py-4 text-xs text-gray-500">{{ h.operator }}</td>
                        </tr>
                        <tr v-if="globalRateHistory.length === 0">
                            <td colspan="5" class="px-6 py-8 text-center text-gray-400">æš‚æ— å˜æ›´è®°å½•</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-if="currentView === 'params'" class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">ç³»ç»Ÿå‚æ•°é…ç½®</h3>
                    <button v-if="hasPermission('edit')" @click="showAddParamModal = true" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-900">
                        + æ–°å¢å‚æ•°
                    </button>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Key</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Value</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase w-20">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr v-for="param in systemParams" :key="param.key">
                            <td class="px-6 py-4 font-mono text-xs">{{ param.key }}</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <input v-if="editingParam === param.key" v-model="param.tempValue" class="border border-opay rounded px-2 py-1 w-full max-w-xs text-sm outline-none bg-green-50">
                                    <span v-else>{{ param.value }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">{{ param.desc }}</td>
                            <td class="px-6 py-4">
                                <button v-if="editingParam !== param.key && hasPermission('edit')" 
                                        @click="startEditParam(param)" 
                                        class="text-opay hover:text-opay-dark font-bold text-xs">ä¿®æ”¹</button>
                                <div v-if="editingParam === param.key" class="flex gap-2">
                                    <button @click="saveParam(param)" class="text-white bg-opay px-2 py-1 rounded text-xs font-bold hover:bg-opay-hover">ä¿å­˜</button>
                                    <button @click="cancelEditParam(param)" class="text-gray-500 text-xs">å–æ¶ˆ</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-if="currentView === 'users'" class="space-y-4">
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">ç”¨æˆ·æƒé™ç®¡ç†</h3>
                        <button @click="showAddUserModal = true" class="bg-gray-800 hover:bg-gray-900 text-white px-3 py-1.5 rounded text-xs font-bold">
                            + æ·»åŠ ç”¨æˆ·
                        </button>
                    </div>
                    <ul class="divide-y divide-gray-100">
                        <li v-for="u in usersList" :key="u.id" class="py-3 flex justify-between items-center">
                            <div>
                                <div class="font-bold text-sm">{{ u.name }} <span class="text-xs text-gray-400 font-normal">(LDAP)</span></div>
                                <div class="text-xs text-gray-500">ID: {{ u.id }}</div>
                            </div>
                            <div class="flex items-center gap-4">
                                <select v-if="hasPermission('user_manage')" @change="updateUserRole(u, $event)" class="text-xs border rounded p-1 bg-gray-50">
                                    <option v-for="r in rolesList" :value="r.code" :selected="u.role === r.code">{{ r.name }}</option>
                                </select>
                                <span v-else class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ getRoleName(u.role) }}
                                </span>
                                <button class="text-gray-400 hover:text-red-500 text-xs">ç§»é™¤</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

             <div v-if="currentView === 'permissions'" class="space-y-4">
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">è§’è‰²ä¸æƒé™é…ç½®</h3>
                        <button @click="initCreateRole" class="bg-opay text-white px-3 py-1.5 rounded text-xs font-bold">
                            + æ–°å»ºè§’è‰²
                        </button>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Role Name / Code</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Assigned Functions</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr v-for="r in rolesList" :key="r.code">
                                <td class="px-6 py-4">
                                    <div class="font-bold text-sm">{{ r.name }}</div>
                                    <div class="text-xs text-gray-400">{{ r.code }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex gap-2">
                                        <span v-for="p in r.functionPoints" :key="p" class="px-2 py-0.5 bg-blue-50 text-blue-700 text-xs rounded border border-blue-100">
                                            {{ getFunctionPointName(p) }}
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button v-if="r.code !== 'SUPER_ADMIN'" @click="editRole(r)" class="text-opay font-bold text-xs hover:underline">é…ç½®æƒé™</button>
                                    <span v-else class="text-gray-400 text-xs italic">ç³»ç»Ÿé»˜è®¤</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden animate-fade-in relative">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">
                    {{ modalMode === 'create' ? 'æ–°å¢äº§å“' : (modalMode === 'edit' ? 'ç¼–è¾‘äº§å“' : 'äº§å“è¯¦æƒ…') }}
                </h3>
                <div class="flex items-center gap-2">
                    <span :class="statusBadgeClass(editingProduct.status)" class="text-xs px-2 py-1 border rounded">{{ editingProduct.status }}</span>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl leading-none ml-4">&times;</button>
                </div>
            </div>

            <div class="flex border-b border-gray-200 px-6 pt-2 space-x-6 bg-white sticky top-0 z-10">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="activeTab = tab.id"
                    :class="activeTab === tab.id ? 'border-opay text-opay' : 'border-transparent text-gray-500 hover:text-gray-700'"
                    class="pb-3 border-b-2 font-bold text-sm transition-colors">
                    {{ tab.name }}
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-gray-50 relative">
                
                <div v-if="isCsvLoading" class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center">
                    <div class="w-8 h-8 border-4 border-opay border-t-transparent rounded-full animate-spin"></div>
                    <div class="mt-2 text-opay font-bold text-sm">æ­£åœ¨è§£æ CSV å¹¶å¡«å……æ•°æ®...</div>
                </div>

                <div v-show="activeTab === 'basic'" class="space-y-4">
                    <div v-if="modalMode === 'create'" class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                        <label class="block text-xs font-bold text-blue-800 mb-2">CSV æ‰¹é‡å¯¼å…¥ (Mock)</label>
                        <input type="file" @change="handleCsvUpload" class="block w-full text-xs text-gray-500 file:mr-4 file:py-1.5 file:px-4 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-6">
                        <div class="form-group">
                            <label class="label-std">Category (å“ç±»)</label>
                            <select v-model="editingProduct.category_code" disabled class="input-std bg-gray-100 text-gray-500 cursor-not-allowed">
                                <option v-for="c in categories" :value="c.code">{{ c.name }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label-std">Product Code</label>
                            <input v-model="editingProduct.product_code" :disabled="modalMode !== 'create'" class="input-std">
                        </div>
                        <div class="form-group">
                            <label class="label-std">Product Name (äº§å“åç§°) <span class="text-red-500">*</span></label>
                            <input v-model="editingProduct.name" :disabled="!isFieldEditable('name')" class="input-std">
                        </div>
                        <div class="form-group">
                            <label class="label-std">Alias (åˆ«å) <span class="text-red-500">*</span></label>
                            <input v-model="editingProduct.alias" :disabled="!isFieldEditable('alias')" class="input-std">
                        </div>
                        <div class="form-group">
                            <label class="label-std">Sub Start Date <span class="text-red-500">*</span></label>
                            <input type="date" v-model="editingProduct.sub_start_date" :disabled="!isFieldEditable('date')" class="input-std">
                        </div>
                        <div class="form-group">
                            <label class="label-std">Sub End Date <span class="text-red-500">*</span></label>
                            <input type="date" v-model="editingProduct.sub_end_date" :disabled="!isFieldEditable('date')" class="input-std">
                        </div>
                    </div>
                </div>

                <div v-show="activeTab === 'rules'" class="grid grid-cols-2 gap-x-4 gap-y-6">
                    <div class="form-group">
                        <label class="label-std">Min Sub Amount (â‚¦) <span class="text-red-500">*</span></label>
                        <input type="number" v-model="editingProduct.min_sub_amount" :disabled="!isFieldEditable('limits')" class="input-std">
                    </div>
                    
                    <div class="form-group">
                        <label class="label-std">
                            Max Single Sub (â‚¦) 
                            <span v-if="editingProduct.category_code === 'Fixed'" class="text-red-500">*</span>
                        </label>
                        <input type="number" v-model="editingProduct.max_single_sub" :disabled="!isFieldEditable('limits')" class="input-std">
                    </div>
                    <div class="form-group">
                        <label class="label-std">
                            Cumulative Limit (â‚¦) 
                            <span v-if="editingProduct.category_code === 'Fixed'" class="text-red-500">*</span>
                        </label>
                        <input type="number" v-model="editingProduct.cum_sub_limit" :disabled="!isFieldEditable('limits')" class="input-std">
                    </div>
                    <div class="form-group">
                        <label class="label-std">
                            Issue Size (â‚¦) 
                            <span v-if="editingProduct.category_code === 'Fixed'" class="text-red-500">*</span>
                        </label>
                        <input type="number" v-model="editingProduct.issue_size" :disabled="!isFieldEditable('limits')" class="input-std">
                    </div>
                    <div class="form-group">
                        <label class="label-std">Target Audience ID</label>
                        <input v-model="editingProduct.target_audience_id" :disabled="!isFieldEditable('limits')" class="input-std">
                    </div>

                    <div class="form-group">
                        <label class="label-std">
                            Product Term (D)
                            <span v-if="editingProduct.category_code === 'Fixed'" class="text-red-500">*</span>
                        </label>
                        <input type="number" v-model="editingProduct.product_term" :disabled="!isFieldEditable('limits')" class="input-std">
                    </div>
                </div>

                <div v-show="activeTab === 'rates'" class="space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="flex items-center gap-2 font-bold text-sm">
                                <input type="checkbox" :checked="editingProduct.is_tiered_rate" disabled class="accent-opay cursor-not-allowed">
                                Is Tiered Rate (Auto-detected: {{ editingProduct.is_tiered_rate ? 'Yes' : 'No' }})
                            </label>
                            <button v-if="isFieldEditable('rates')" @click="addRateRow" class="text-xs bg-opay text-white px-2 py-1 rounded hover:bg-opay-hover">+ Add Rate</button>
                        </div>
                        <div class="border rounded bg-white overflow-hidden">
                            <table class="min-w-full text-left">
                                <thead class="bg-gray-100 text-xs text-gray-500 uppercase">
                                    <tr>
                                        <th class="px-4 py-2">Min Amount (Step)</th>
                                        <th class="px-4 py-2">Rate (%) - Input 15 for 15%</th>
                                        <th class="px-4 py-2 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y text-sm">
                                    <tr v-for="(r, idx) in editingProduct.rates" :key="idx">
                                        <td class="p-2">
                                            <input type="number" v-model="r.stepMinAmount" :disabled="!isFieldEditable('rates')" class="w-full border border-gray-300 p-1.5 rounded">
                                        </td>
                                        <td class="p-2 relative">
                                            <input type="number" v-model="r.displayRate" @input="updateRealRate(r)" :disabled="!isFieldEditable('rates')" class="w-full border border-gray-300 p-1.5 rounded font-bold text-opay">
                                        </td>
                                        <td class="p-2 text-center">
                                            <button v-if="isFieldEditable('rates')" @click="removeRateRow(idx)" class="text-red-500">&times;</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-show="activeTab === 'advanced'">
                    <label class="label-std">Config JSON (æ”¯æŒçƒ­æ›´)</label>
                    <textarea v-model="editingProduct.config_json" :disabled="!isFieldEditable('config')" class="w-full h-64 border border-gray-300 rounded p-2 text-xs font-mono bg-gray-50 focus:border-opay focus:ring-1 focus:ring-opay outline-none"></textarea>
                </div>

                <div v-show="activeTab === 'rate_history'">
                    <div class="bg-white border rounded overflow-hidden">
                        <table class="min-w-full text-left text-xs">
                            <thead class="bg-gray-100 uppercase">
                                <tr>
                                    <th class="px-4 py-2">Change Date</th>
                                    <th class="px-4 py-2">Operator</th>
                                    <th class="px-4 py-2">Rate Config</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr v-for="h in mockRateHistory" :key="h.date">
                                    <td class="px-4 py-2">{{ h.date }}</td>
                                    <td class="px-4 py-2">{{ h.operator }}</td>
                                    <td class="px-4 py-2 font-mono text-gray-600">{{ h.rate_info }}</td>
                                </tr>
                                <tr v-if="mockRateHistory.length === 0">
                                    <td colspan="3" class="px-4 py-4 text-center text-gray-400">æš‚æ— å†å²è®°å½•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded text-sm font-bold">å…³é—­</button>
                
                <button v-if="modalMode !== 'view'" @click="saveProduct" class="px-5 py-2 bg-opay hover:bg-opay-hover text-white rounded shadow text-sm font-bold">
                    {{ (editingProduct.status === 'è‰ç¨¿' || modalMode === 'create') ? 'ä¿å­˜è‰ç¨¿' : 'ä¿å­˜ä¿®æ”¹ç”³è¯·' }}
                </button>
                
                <button v-if="editingProduct.status === 'è‰ç¨¿' && modalMode !== 'create'" @click="initiateApproval(editingProduct, 'listing')" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow text-sm font-bold">
                    æäº¤ä¸Šæ¶ç”³è¯·
                </button>
            </div>
        </div>
    </div>

    <div v-if="showDiffModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-8 backdrop-blur-sm">
        <div class="bg-white w-full h-full max-w-5xl rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="px-6 py-4 bg-gray-800 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold">äº§å“å˜æ›´é¢„è§ˆ (Product Change Preview)</h3>
                <span class="bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded">PRE-APPROVAL</span>
            </div>
            
            <div class="flex-1 flex overflow-hidden font-mono text-xs">
                <div class="flex-1 bg-gray-50 p-6 overflow-y-auto border-r border-gray-200">
                    <h4 class="font-bold text-gray-500 mb-4 uppercase border-b pb-2">å˜æ›´å‰</h4>
                    <div class="space-y-2">
                         <div class="grid grid-cols-3 gap-2 border-b border-gray-100 pb-1">
                            <span class="text-gray-400 font-bold">é”€å”®çŠ¶æ€</span>
                            <span class="col-span-2 text-gray-600">{{ originalSnapshot.status }}</span>
                        </div>
                        <template v-for="(val, key) in originalSnapshot" :key="key">
                            <div v-if="key !== 'status'" class="grid grid-cols-3 gap-2 border-b border-gray-100 pb-1">
                                <span class="text-gray-400 font-bold">{{ getFieldName(key) }}</span>
                                <span class="col-span-2 text-gray-600 break-all whitespace-pre-wrap">{{ formatDiffValue(key, val) }}</span>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="flex-1 bg-white p-6 overflow-y-auto">
                    <h4 class="font-bold text-opay mb-4 uppercase border-b pb-2">å˜æ›´å (æ‹Ÿ)</h4>
                    <div class="space-y-2">
                         <div class="px-4 py-2 bg-blue-50 border border-blue-100 rounded mb-4 text-xs text-blue-800 flex justify-between items-center">
                            <div class="flex gap-4">
                                <span>ğŸ’° é¢„ç®—æˆæœ¬é‡‘é¢: <span class="font-bold">$3,000.00</span></span>
                                <span>ğŸš€ å°†å‘èµ·å®¡æ‰¹æµ: <span class="font-mono font-bold">{{ getSystemParam('APPROVAL_FLOW_ID') }}</span></span>
                            </div>
                            <a href="about:blank" target="_blank" class="underline hover:text-blue-600">ğŸ“– äº§å“å‘è¡Œ/å˜æ›´å®¡æ‰¹è§„åˆ™è¯´æ˜</a>
                        </div>

                         <div class="grid grid-cols-3 gap-2 border-b border-gray-100 pb-1" 
                              :class="originalSnapshot.status !== getTargetStatusLabel() ? 'bg-yellow-100 -mx-2 px-2 rounded' : ''">
                            <span class="text-gray-400 font-bold">é”€å”®çŠ¶æ€</span>
                            <span class="col-span-2 font-bold" 
                                  :class="originalSnapshot.status !== getTargetStatusLabel() ? 'text-red-600' : 'text-gray-600'">
                                  {{ getTargetStatusLabel() }}
                            </span>
                        </div>

                        <template v-for="(val, key) in diffResult" :key="key">
                            <div v-if="key !== 'status'" :class="val.changed ? 'bg-yellow-100 -mx-2 px-2 rounded' : ''" class="grid grid-cols-3 gap-2 border-b border-gray-100 pb-1">
                                <span class="text-gray-400 font-bold">{{ getFieldName(key) }}</span>
                                <span class="col-span-2 break-all whitespace-pre-wrap" :class="val.changed ? 'text-red-600 font-bold' : 'text-gray-600'">
                                    {{ formatDiffValue(key, val.newVal) }}
                                </span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t flex justify-end gap-3">
                <button @click="showDiffModal = false" class="px-4 py-2 text-gray-600 font-bold">è¿”å›ä¿®æ”¹</button>
                <button @click="confirmApproval" class="px-6 py-2 bg-opay hover:bg-opay-hover text-white font-bold rounded shadow">
                    ç¡®è®¤å¹¶æäº¤å®¡æ‰¹
                </button>
            </div>
        </div>
    </div>

    <div v-if="showRoleModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-xl shadow-xl p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">{{ roleModalMode === 'create' ? 'æ–°å»ºè§’è‰²' : 'é…ç½®æƒé™' }}</h3>
            <div class="space-y-4">
                <div class="form-group">
                    <label class="label-std">Role Name</label>
                    <input v-model="editingRole.name" type="text" :disabled="roleModalMode !== 'create'" class="input-std">
                </div>
                <div class="form-group">
                    <label class="label-std">Role Code</label>
                    <input v-model="editingRole.code" type="text" :disabled="roleModalMode !== 'create'" class="input-std">
                </div>
                <div class="form-group">
                    <label class="label-std">åŠŸèƒ½æƒé™ (Function Points)</label>
                    <div class="space-y-2 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="PERMISSION_MANAGE" v-model="editingRole.functionPoints" class="accent-opay">
                            <span class="text-sm">æƒé™ç®¡ç† (Permission Mgmt)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="PRODUCT_MANAGE" v-model="editingRole.functionPoints" class="accent-opay">
                            <span class="text-sm">äº§å“ç®¡ç† (Product Mgmt)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="QUERY" v-model="editingRole.functionPoints" class="accent-opay">
                            <span class="text-sm">æŸ¥è¯¢ (Query)</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button @click="showRoleModal = false" class="text-gray-500 font-bold text-sm">å–æ¶ˆ</button>
                <button @click="saveRole" class="bg-opay text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-opay-hover">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div v-if="showAddUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-xl shadow-xl p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ·»åŠ ç”¨æˆ·</h3>
            <div class="space-y-4">
                <div class="form-group">
                    <label class="label-std">LDAP (é£ä¹¦è´¦å·)</label>
                    <input v-model="newUserForm.name" type="text" placeholder="e.g. zhangsan" class="input-std">
                </div>
                <div class="form-group">
                    <label class="label-std">åˆ†é…è§’è‰²</label>
                    <select v-model="newUserForm.role" class="input-std">
                        <option v-for="role in rolesList" :value="role.code">{{ role.name }}</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button @click="showAddUserModal = false" class="text-gray-500 font-bold text-sm">å–æ¶ˆ</button>
                <button @click="confirmAddUser" class="bg-opay text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-opay-hover" :disabled="!newUserForm.name">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div v-if="showAddParamModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-xl shadow-xl p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢ç³»ç»Ÿå‚æ•°</h3>
            <div class="space-y-4">
                <div class="form-group">
                    <label class="label-std">Key (Unique)</label>
                    <input v-model="newParamForm.key" type="text" placeholder="e.g. RISK_LEVEL" class="input-std uppercase">
                </div>
                <div class="form-group">
                    <label class="label-std">Value</label>
                    <input v-model="newParamForm.value" type="text" class="input-std">
                </div>
                 <div class="form-group">
                    <label class="label-std">Description</label>
                    <input v-model="newParamForm.desc" type="text" class="input-std">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button @click="showAddParamModal = false" class="text-gray-500 font-bold text-sm">å–æ¶ˆ</button>
                <button @click="confirmAddParam" class="bg-opay text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-opay-hover" :disabled="!newParamForm.key">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-4 left-4 z-[100] bg-gray-800 text-white p-3 rounded-lg shadow-xl opacity-90 hover:opacity-100 transition">
        <div class="text-[10px] text-gray-400 mb-1 font-bold uppercase">Debug: Time Travel</div>
        <div class="flex items-center gap-2">
            <div class="font-mono text-sm bg-black px-2 py-1 rounded">{{ systemDate }}</div>
            <button @click="addDays(1)" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-xs">+1D</button>
            <button @click="addDays(5)" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-xs">+5D</button>
        </div>
    </div>

    <transition name="toast">
        <div v-if="toast.show" class="fixed top-6 right-6 bg-gray-900 text-white px-6 py-4 rounded shadow-xl z-[100] flex items-center gap-3">
            <span class="text-xl">{{ toast.icon }}</span>
            <div>
                <div class="font-bold text-sm">{{ toast.title }}</div>
                <div class="text-xs text-gray-400">{{ toast.msg }}</div>
            </div>
        </div>
    </transition>

</div>

<script>
    const STANDARD_PRODUCTS = [
        'OWealth', 'Targets', 'SafeBox', 'Spend & Save', 'Sub-account', 'Superbalance', 
        'Fixed_100401', 'Fixed_100402'
    ];

    const FIELD_NAMES = {
        name: 'äº§å“åç§°',
        product_code: 'äº§å“ä»£ç ',
        category_code: 'æ‰€å±å“ç±»',
        alias: 'äº§å“åˆ«å',
        status: 'é”€å”®çŠ¶æ€',
        is_tiered_rate: 'æ˜¯å¦é˜¶æ¢¯åˆ©ç‡',
        rates: 'åˆ©ç‡é…ç½®',
        sub_start_date: 'ç”³è´­èµ·å§‹æ—¥',
        sub_end_date: 'ç”³è´­ç»“æŸæ—¥',
        min_sub_amount: 'ç”³è´­èµ·ç‚¹',
        max_single_sub: 'å•ç¬”ä¸Šé™',
        cum_sub_limit: 'ç´¯è®¡é™é¢',
        issue_size: 'å‘è¡Œè§„æ¨¡',
        config_json: 'é«˜çº§é…ç½®JSON',
        target_audience_id: 'å®¢ç¾¤ID',
        product_term: 'äº§å“æœŸé™(å¤©)'
    };

    const STATUS_MAP = {
        'Active': 'å¼€æ”¾ä¸­',
        'Draft': 'è‰ç¨¿',
        'Approved': 'å·²ä¸Šæ¶å¾…å¼€æ”¾',
        'Suspended': 'å·²ä¸‹æ¶',
        'Pending_Approval': 'ä¸Šæ¶å®¡æ‰¹ä¸­',
        'Pending_Modification': 'ä¿®æ”¹å®¡æ‰¹ä¸­',
        'Pending_OffShelf': 'ä¸‹æ¶å®¡æ‰¹ä¸­',
        'Expired': 'å·²è¿‡æœŸ'
    };

    const PERM_MAPPING = {
        'PRODUCT_MANAGE': ['view', 'edit', 'add', 'audit', 'off_shelf'],
        'QUERY': ['view'],
        'PERMISSION_MANAGE': ['user_manage', 'permission_manage']
    };

    const FUNCTION_POINT_NAMES = {
        'PRODUCT_MANAGE': 'äº§å“ç®¡ç†',
        'QUERY': 'æŸ¥è¯¢',
        'PERMISSION_MANAGE': 'æƒé™ç®¡ç†'
    };

    const app = Vue.createApp({
        data() {
            return {
                configLoaded: false,
                currentRoleCode: 'SUPER_ADMIN',
                currentView: 'registry',
                
                // System Date for Debug
                systemDate: new Date().toISOString().split('T')[0],

                // Data
                rolesList: [],
                categories: [],
                products: [],
                systemParams: [],
                usersList: [],
                globalRateHistory: [],

                // Filters
                filters: { category: '', status: '' },

                // Modal: Form
                showModal: false,
                modalMode: 'view',
                activeTab: 'basic',
                editingProduct: {},
                originalSnapshot: {},
                isCsvLoading: false,
                mockRateHistory: [],

                // Modal: Diff
                showDiffModal: false,
                pendingApprovalAction: '',

                // Modal: Add User
                showAddUserModal: false,
                newUserForm: { name: '', role: 'USER' },

                // Modal: Role Editor
                showRoleModal: false,
                roleModalMode: 'edit',
                editingRole: { name: '', code: '', functionPoints: [] },

                // Modal: Add Param
                showAddParamModal: false,
                newParamForm: { key: '', value: '', desc: '' },

                // Monitor Data
                monitorList: [],
                monitorLastUpdated: '-',

                // Editing Params
                editingParam: null,

                // Toast
                toast: { show: false, title: '', msg: '', icon: '' },

                tabs: [
                    { id: 'basic', name: 'åŸºç¡€ä¿¡æ¯' },
                    { id: 'rules', name: 'äº¤æ˜“è§„åˆ™' },
                    { id: 'rates', name: 'åˆ©ç‡' }, 
                    { id: 'advanced', name: 'é«˜çº§é…ç½®' },
                    { id: 'rate_history', name: 'åˆ©ç‡å˜æ›´è®°å½•' }
                ]
            }
        },
        computed: {
            currentUser() {
                return { name: 'Admin', role: this.currentRoleCode };
            },
            filteredProducts() {
                return this.products.filter(p => {
                    const displayStatus = this.getDisplayStatus(p);
                    const matchCat = !this.filters.category || p.category_code === this.filters.category;
                    const matchStat = !this.filters.status || displayStatus === this.filters.status;
                    return matchCat && matchStat;
                });
            },
            diffResult() {
                const diff = {};
                const keys = Object.keys({ ...this.originalSnapshot, ...this.editingProduct });
                keys.forEach(key => {
                    if (['displayRate', 'update_time', 'operator', 'sold_amount'].includes(key)) return;
                    
                    if (key === 'rates') {
                         const oldRates = JSON.stringify(this.originalSnapshot[key]);
                         const newRates = JSON.stringify(this.editingProduct[key]);
                         diff[key] = { newVal: this.editingProduct[key], changed: oldRates !== newRates };
                    } else {
                        const oldVal = this.originalSnapshot[key];
                        const newVal = this.editingProduct[key];
                        diff[key] = { newVal, changed: oldVal != newVal };
                    }
                });
                return diff;
            }
        },
        created() {
            if (typeof window.OPAY_FINANCE_CONFIG !== 'undefined') {
                this.configLoaded = true;
                const C = window.OPAY_FINANCE_CONFIG;
                
                // Init Roles
                this.rolesList = [
                    { code: 'SUPER_ADMIN', name: 'è¶…çº§ç®¡ç†å‘˜', functionPoints: ['PERMISSION_MANAGE', 'PRODUCT_MANAGE', 'QUERY'] },
                    { code: 'PRODUCT_ADMIN', name: 'äº§å“ç®¡ç†å‘˜', functionPoints: ['PRODUCT_MANAGE', 'QUERY'] },
                    { code: 'USER', name: 'ä¸€èˆ¬ç”¨æˆ·', functionPoints: ['QUERY'] }
                ];

                this.categories = C.categories;
                
                this.products = C.products.map(p => {
                    let statusCN = STATUS_MAP[p.status] || p.status;
                    // Fix 2: Reset sold_amount for Fixed_1005 (Special Test)
                    let soldAmount = p.category_code === 'Fixed' ? Math.floor(Math.random() * (p.issue_size || 1000000)) : 0;
                    if (p.product_code === 'Fixed_1005') soldAmount = 0;

                    return { 
                        ...p, 
                        status: statusCN,
                        update_time: '2025-12-10 14:30',
                        operator: 'admin',
                        sold_amount: soldAmount
                    };
                });

                this.systemParams = C.system_params
                    .filter(p => p.key !== 'GLOBAL_RISK_RATE')
                    .map(p => ({ ...p, tempValue: p.value }));

                this.usersList = C.users;

                // Fix: Empty history
                this.globalRateHistory = [];

                // Initial Check on Load
                this.products.forEach(p => this.checkAutoActive(p));
                this.updateMonitorList();

            } else {
                this.configLoaded = false;
            }
        },
        methods: {
            // --- Helpers ---
            hasPermission(granularPerm) {
                const currentRole = this.rolesList.find(r => r.code === this.currentRoleCode);
                if (!currentRole) return false;
                return currentRole.functionPoints.some(fp => {
                    const coveredPerms = PERM_MAPPING[fp] || [];
                    return coveredPerms.includes(granularPerm);
                });
            },
            getFunctionPointName(fp) {
                return FUNCTION_POINT_NAMES[fp] || fp;
            },
            isStandardProduct(code) {
                return STANDARD_PRODUCTS.includes(code);
            },
            navClass(view) {
                return this.currentView === view ? 'bg-opay-light text-opay font-bold' : 'text-gray-600 hover:bg-gray-50';
            },
            getSystemParam(key) {
                const param = this.systemParams.find(p => p.key === key);
                return param ? param.value : 'N/A';
            },
            // Fix: Hide Edit Button logic
            canShowEditButton(p) {
                if (!this.hasPermission('edit')) return false;
                const status = this.getDisplayStatus(p);
                // Fix: Fix 2: 'å·²ä¸‹æ¶' -> No Edit. 'å·²è¿‡æœŸ' -> No Edit.
                // 'å·²å”®ç½„' should be editable if not expired/suspended
                const forbidden = ['å·²ä¸‹æ¶', 'å·²è¿‡æœŸ', 'ä¸Šæ¶å®¡æ‰¹ä¸­', 'ä¿®æ”¹å®¡æ‰¹ä¸­', 'ä¸‹æ¶å®¡æ‰¹ä¸­'];
                return !forbidden.includes(status);
            },
            getFieldName(key) {
                return FIELD_NAMES[key] || key;
            },
            formatMoneyRaw(val) {
                if(val === undefined || val === null) return '0';
                return Number(val).toLocaleString();
            },
            formatMoney(val) {
                return 'â‚¦' + this.formatMoneyRaw(val);
            },
            
            // --- TIME TRAVEL & STATUS LOGIC (FIXED) ---
            addDays(n) {
                const d = new Date(this.systemDate);
                d.setDate(d.getDate() + n);
                this.systemDate = d.toISOString().split('T')[0];
                this.showToast(`ç³»ç»Ÿæ—¶é—´å·²å¿«è¿›è‡³: ${this.systemDate}`, 'ğŸ“…');
                
                // å…³é”®ä¿®å¤ï¼šæ—¶é—´å˜åŒ–åï¼Œç«‹å³éå†æ‰€æœ‰äº§å“æ£€æŸ¥æ˜¯å¦è§¦å‘è‡ªåŠ¨ä¸Šæ¶
                let activatedCount = 0;
                this.products.forEach(p => {
                    if(this.checkAutoActive(p)) activatedCount++;
                });
                
                if (activatedCount > 0) {
                    this.showToast(`è§¦å‘ ${activatedCount} ä¸ªäº§å“è‡ªåŠ¨ä¸Šæ¶`, 'âš¡');
                }

                // Force reactivity and update monitor
                this.products = [...this.products]; 
                this.updateMonitorList();
            },
            
            // Core Logic for Status Display
            getDisplayStatus(p) {
                // Expired Check (Dynamic)
                if (['å¼€æ”¾ä¸­', 'å·²ä¸Šæ¶å¾…å¼€æ”¾'].includes(p.status)) {
                    if (p.sub_end_date && p.sub_end_date < this.systemDate) {
                        return 'å·²è¿‡æœŸ';
                    }
                }
                
                // Auto Open Check (Client-side simulation)
                if (p.status === 'å·²ä¸Šæ¶å¾…å¼€æ”¾' && p.sub_start_date <= this.systemDate) {
                    return 'å¼€æ”¾ä¸­'; 
                }
                
                // Sold Out Logic Check (Simulation)
                if (p.category_code === 'Fixed' && p.issue_size > 0 && p.sold_amount >= p.issue_size && p.status === 'å¼€æ”¾ä¸­') {
                    return 'å·²å”®ç½„';
                }

                return p.status;
            },
            
            // Core Logic for State Mutation (Auto Active)
            checkAutoActive(product) {
                // ä¿®å¤ï¼šä½¿ç”¨ this.systemDate è€Œä¸æ˜¯ new Date()
                if (product.status === 'å·²ä¸Šæ¶å¾…å¼€æ”¾' && this.systemDate >= product.sub_start_date) {
                    product.status = 'å¼€æ”¾ä¸­';
                    return true;
                }
                return false;
            },
            
            statusBadgeClass(status) {
                const map = {
                    'å¼€æ”¾ä¸­': 'bg-green-100 text-green-800 border-green-200',
                    'è‰ç¨¿': 'bg-gray-100 text-gray-600 border-gray-200',
                    'ä¸Šæ¶å®¡æ‰¹ä¸­': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'ä¿®æ”¹å®¡æ‰¹ä¸­': 'bg-orange-100 text-orange-800 border-orange-200',
                    'ä¸‹æ¶å®¡æ‰¹ä¸­': 'bg-red-50 text-red-600 border-red-100',
                    'å·²ä¸Šæ¶å¾…å¼€æ”¾': 'bg-blue-100 text-blue-800 border-blue-200',
                    'å·²ä¸‹æ¶': 'bg-red-100 text-red-800 border-red-200',
                    'å·²è¿‡æœŸ': 'bg-gray-300 text-gray-700 border-gray-400',
                    'å·²å”®ç½„': 'bg-red-500 text-white border-red-600'
                };
                return map[status] || 'bg-gray-100';
            },
            showToast(title, icon='âœ…') {
                this.toast = { show: true, title, msg: '', icon };
                setTimeout(() => this.toast.show = false, 3000);
            },
            getRoleName(code) {
                const r = this.rolesList.find(r => r.code === code);
                return r ? r.name : code;
            },

            // --- Rate Logic ---
            formatRateForDisplay(rate) {
                return rate ? parseFloat((rate * 100).toFixed(4)) : 0;
            },
            updateRealRate(rateObj) {
                rateObj.rate = rateObj.displayRate / 100;
            },

            // --- Monitor Logic ---
            updateMonitorList() {
                this.monitorLastUpdated = new Date().toLocaleTimeString();
                this.monitorList = this.products
                    .filter(p => {
                        const status = this.getDisplayStatus(p);
                        // Filter out Off-shelf explicitly (Req #5)
                        if (status === 'å·²ä¸‹æ¶' || status === 'å·²è¿‡æœŸ') return false;
                        return p.category_code === 'Fixed' && p.issue_size > 0;
                    })
                    .map(p => {
                        const progress = p.issue_size > 0 ? Math.floor((p.sold_amount / p.issue_size) * 100) : 0;
                        return { ...p, progress };
                    });
            },
            refreshMonitor() {
                this.monitorList.forEach(item => {
                    // Fix: Only increment if Open
                    const status = this.getDisplayStatus(item);
                    if (status === 'å¼€æ”¾ä¸­') {
                        // Increase by 5% of issue size
                        const change = Math.floor(item.issue_size * 0.05);
                        item.sold_amount = Math.min(item.issue_size, item.sold_amount + change);
                        item.progress = Math.floor((item.sold_amount / item.issue_size) * 100);
                        
                        // Sync back to main product list
                        const p = this.products.find(x => x.product_code === item.product_code);
                        if(p) p.sold_amount = item.sold_amount;
                    }
                });
                
                // Force UI update for statuses like "Sold Out"
                this.products = [...this.products]; 
                this.monitorLastUpdated = new Date().toLocaleTimeString();
                this.showToast('é¢åº¦æ•°æ®å·²åˆ·æ–°');
            },
            getProgressBarColor(item, text=false) {
                const status = this.getDisplayStatus(item);
                if (status === 'å·²ä¸Šæ¶å¾…å¼€æ”¾') return text ? 'text-blue-500' : 'bg-blue-500';
                if (item.progress >= 100 || status === 'å·²å”®ç½„') return text ? 'text-red-500' : 'bg-red-500';
                return text ? 'text-opay' : 'bg-opay';
            },

            // --- System Params Logic ---
            startEditParam(param) {
                this.editingParam = param.key;
                param.tempValue = param.value;
            },
            cancelEditParam(param) {
                this.editingParam = null;
            },
            saveParam(param) {
                param.value = param.tempValue;
                this.editingParam = null;
                this.showToast('å‚æ•°å·²ä¿å­˜');
            },
            confirmAddParam() {
                if(!this.newParamForm.key || !this.newParamForm.value) return;
                this.systemParams.push({
                    key: this.newParamForm.key,
                    value: this.newParamForm.value,
                    desc: this.newParamForm.desc,
                    tempValue: this.newParamForm.value
                });
                this.showAddParamModal = false;
                this.newParamForm = { key: '', value: '', desc: '' };
                this.showToast('å‚æ•°æ·»åŠ æˆåŠŸ');
            },

            // --- Form Logic ---
            isFieldEditable(field) {
                if (this.modalMode === 'view') return false;
                if (this.modalMode === 'create') return true;
                
                // Special Rule for Non-Fixed products in Limits section
                if (field === 'limits' && this.editingProduct.category_code !== 'Fixed') return false;

                const status = this.editingProduct.status;
                
                // Fix 6 & 7: Lock if Pending or Suspended
                if (status.includes('å®¡æ‰¹ä¸­') || status === 'å·²ä¸‹æ¶') return false;

                if (status === 'è‰ç¨¿') return true;
                if (['å¼€æ”¾ä¸­', 'å·²ä¸Šæ¶å¾…å¼€æ”¾', 'å·²è¿‡æœŸ'].includes(status)) {
                    if (['name', 'category', 'code'].includes(field)) return false;
                    if (['alias', 'date', 'limits', 'rates', 'config'].includes(field)) return true;
                }
                return false;
            },

            // --- Create Flow ---
            initCreateProduct() {
                const fixedCat = this.categories.find(c => c.code === 'Fixed');
                if (!fixedCat) return;
                this.openModal('create', { category_code: 'Fixed' });
            },

            // --- Modal ---
            openModal(mode, product) {
                this.modalMode = mode;
                this.activeTab = 'basic';
                if (mode === 'create') {
                    this.editingProduct = {
                        product_code: 'Fixed_' + Date.now(),
                        category_code: 'Fixed',
                        status: 'è‰ç¨¿',
                        rates: [{ rate: 0, displayRate: 0, stepMinAmount: 0 }],
                        is_tiered_rate: false
                    };
                    this.originalSnapshot = {};
                    this.mockRateHistory = [];
                } else {
                    this.editingProduct = JSON.parse(JSON.stringify(product));
                    if (this.editingProduct.rates) {
                        this.editingProduct.rates.forEach(r => {
                            r.displayRate = this.formatRateForDisplay(r.rate);
                        });
                    }
                    this.originalSnapshot = JSON.parse(JSON.stringify(product));
                    // Mock History
                    this.mockRateHistory = this.globalRateHistory.filter(h => h.product_name === product.name);
                }
                this.showModal = true;
            },
            closeModal() {
                this.showModal = false;
            },

            // --- Role Management ---
            initCreateRole() {
                this.roleModalMode = 'create';
                this.editingRole = { name: '', code: 'NEW_ROLE', functionPoints: [] };
                this.showRoleModal = true;
            },
            editRole(role) {
                this.roleModalMode = 'edit';
                this.editingRole = JSON.parse(JSON.stringify(role));
                this.showRoleModal = true;
            },
            saveRole() {
                if (this.roleModalMode === 'create') {
                    this.rolesList.push(this.editingRole);
                } else {
                    const idx = this.rolesList.findIndex(r => r.code === this.editingRole.code);
                    if (idx !== -1) {
                        this.rolesList[idx] = this.editingRole;
                    }
                }
                this.showRoleModal = false;
                this.showToast('è§’è‰²é…ç½®å·²ä¿å­˜');
            },

            // --- Actions ---
            deleteProduct(p) {
                if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‰ç¨¿å—ï¼Ÿ')) return;
                const idx = this.products.indexOf(p);
                if (idx > -1) {
                    this.products.splice(idx, 1);
                    this.showToast('è‰ç¨¿å·²åˆ é™¤', 'ğŸ—‘ï¸');
                }
            },
            applyForOffShelf(p) {
                this.initiateApproval(p, 'offshelf');
            },
            initiateApprovalFromList(p) {
                this.initiateApproval(p, 'listing');
            },

            // --- User Mgmt ---
            confirmAddUser() {
                const newUser = {
                    id: this.usersList.length + 1,
                    name: this.newUserForm.name,
                    role: this.newUserForm.role
                };
                this.usersList.push(newUser);
                this.showAddUserModal = false;
                this.newUserForm = { name: '', role: 'USER' };
                this.showToast('ç”¨æˆ·æ·»åŠ æˆåŠŸ', 'ğŸ‘¤');
            },
            updateUserRole(u, event) {
                u.role = event.target.value;
                this.showToast('æƒé™å·²æ›´æ–°', 'ğŸ”’');
            },

            // --- CSV Mock ---
            handleCsvUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                this.isCsvLoading = true;
                setTimeout(() => {
                    this.editingProduct.name = "Fixed Deposit (Imported)";
                    this.editingProduct.min_sub_amount = 50000;
                    this.editingProduct.issue_size = 100000000;
                    this.editingProduct.sub_start_date = this.systemDate;
                    const d = new Date(this.systemDate);
                    d.setDate(d.getDate() + 30);
                    this.editingProduct.sub_end_date = d.toISOString().split('T')[0];
                    this.editingProduct.rates = [{rate: 0.12, displayRate: 12, stepMinAmount: 0}];
                    this.isCsvLoading = false;
                    this.showToast('CSV è§£ææˆåŠŸ', 'ğŸ“„');
                }, 1000);
            },
            
            // --- Rate Row Logic + Auto Tiered Toggle ---
            addRateRow() {
                this.editingProduct.rates.push({ rate: 0, displayRate: 0, stepMinAmount: 0 });
                this.checkTieredStatus();
            },
            removeRateRow(idx) {
                this.editingProduct.rates.splice(idx, 1);
                this.checkTieredStatus();
            },
            checkTieredStatus() {
                if (this.editingProduct.rates.length > 1) {
                    this.editingProduct.is_tiered_rate = true;
                } else {
                    this.editingProduct.is_tiered_rate = false;
                }
            },

            saveProduct() {
                // Fix 4: Detect Changes & Prevent Save if Identical
                if (this.modalMode !== 'create') {
                    // Create clean copies for comparison (removing UI fields)
                    const cleanEdit = JSON.parse(JSON.stringify(this.editingProduct));
                    const cleanOrig = JSON.parse(JSON.stringify(this.originalSnapshot));
                    
                    const ignoredKeys = ['update_time', 'operator', 'sold_amount', 'displayRate'];
                    ignoredKeys.forEach(k => { delete cleanEdit[k]; delete cleanOrig[k]; });
                    
                    if (cleanEdit.rates) cleanEdit.rates.forEach(r => delete r.displayRate);
                    if (cleanOrig.rates) cleanOrig.rates.forEach(r => delete r.displayRate);

                    if (JSON.stringify(cleanEdit) === JSON.stringify(cleanOrig)) {
                        this.showToast('æ²¡æœ‰åšä»»ä½•ä¿®æ”¹', 'âš ï¸');
                        return;
                    }
                }

                // Validation Logic
                if (!this.editingProduct.name) return alert('äº§å“åç§°ä¸èƒ½ä¸ºç©º');
                if (!this.editingProduct.alias) return alert('åˆ«åä¸èƒ½ä¸ºç©º');
                if (!this.editingProduct.sub_start_date) return alert('èµ·å§‹æ—¥æœŸå¿…å¡«');
                if (!this.editingProduct.sub_end_date) return alert('ç»“æŸæ—¥æœŸå¿…å¡«');
                if (!this.editingProduct.min_sub_amount) return alert('æœ€å°ç”³è´­é¢å¿…å¡«');
                
                if (this.editingProduct.category_code === 'Fixed') {
                    if (!this.editingProduct.max_single_sub) return alert('å•ç¬”ä¸Šé™å¿…å¡«');
                    if (!this.editingProduct.cum_sub_limit) return alert('ç´¯è®¡é™é¢å¿…å¡«');
                    if (!this.editingProduct.issue_size) return alert('å‘è¡Œè§„æ¨¡å¿…å¡«');
                }

                if (this.modalMode === 'create') {
                    this.editingProduct.update_time = new Date().toLocaleString();
                    this.editingProduct.operator = this.currentUser.name;
                    this.editingProduct.sold_amount = 0;
                    this.products.push(this.editingProduct);
                    this.showToast('äº§å“è‰ç¨¿å·²ä¿å­˜');
                    this.closeModal();
                } else if (this.editingProduct.status === 'è‰ç¨¿') {
                    const idx = this.products.findIndex(p => p.product_code === this.editingProduct.product_code);
                    if (idx !== -1) {
                        this.editingProduct.update_time = new Date().toLocaleString();
                        this.editingProduct.operator = this.currentUser.name;
                        this.products[idx] = { ...this.editingProduct };
                    }
                    this.showToast('è‰ç¨¿ä¿®æ”¹å·²ä¿å­˜');
                    this.closeModal();
                } else {
                    this.initiateApproval(this.editingProduct, 'modify');
                }
                this.updateMonitorList();
            },

            // --- Workflow ---
            initiateApproval(product, action) {
                this.editingProduct = JSON.parse(JSON.stringify(product));
                this.originalSnapshot = JSON.parse(JSON.stringify(
                    this.products.find(p => p.product_code === product.product_code) || product
                ));
                this.pendingApprovalAction = action || 'modify';
                this.showDiffModal = true;
            },
            getTargetStatusLabel() {
                 if (this.pendingApprovalAction === 'listing') return 'å·²ä¸Šæ¶å¾…å¼€æ”¾';
                 if (this.pendingApprovalAction === 'offshelf') return 'å·²ä¸‹æ¶';
                 return this.editingProduct.status;
            },
            formatDiffValue(key, val) {
                if (key === 'rates' && Array.isArray(val)) {
                    return val.map(r => `â‰¥ ${this.formatMoneyRaw(r.stepMinAmount)} : ${(r.rate*100).toFixed(2)}%`).join('\n');
                }
                if (typeof val === 'object') return JSON.stringify(val);
                return val;
            },
            confirmApproval() {
                const idx = this.products.findIndex(p => p.product_code === this.editingProduct.product_code);
                let newStatus = '';
                
                if (this.pendingApprovalAction === 'listing') newStatus = 'ä¸Šæ¶å®¡æ‰¹ä¸­';
                if (this.pendingApprovalAction === 'modify') newStatus = 'ä¿®æ”¹å®¡æ‰¹ä¸­';
                if (this.pendingApprovalAction === 'offshelf') newStatus = 'ä¸‹æ¶å®¡æ‰¹ä¸­';

                if (idx !== -1) {
                    this.products[idx].status = newStatus;
                    this.products[idx].update_time = new Date().toLocaleString();
                    this.products[idx].operator = this.currentUser.name;

                    if (this.pendingApprovalAction === 'modify') {
                        this.products[idx] = { ...this.editingProduct, status: newStatus };
                        // Mock History Push
                        if (this.diffResult.rates && this.diffResult.rates.changed) {
                            this.globalRateHistory.push({
                                id: Date.now(),
                                date: new Date().toLocaleString(),
                                product_name: this.editingProduct.name,
                                category: this.editingProduct.category_code,
                                rate_info: this.formatDiffValue('rates', this.editingProduct.rates),
                                operator: this.currentUser.name
                            });
                        }
                    }
                }
                
                this.showDiffModal = false;
                this.showModal = false;
                this.updateMonitorList();
                this.showToast('å·²æäº¤é£ä¹¦å®¡æ‰¹', 'ğŸš€');
            },
            mockFeishuPass(p) {
                let nextStatus = 'å¼€æ”¾ä¸­'; 
                
                if (p.status === 'ä¸Šæ¶å®¡æ‰¹ä¸­') {
                    nextStatus = 'å·²ä¸Šæ¶å¾…å¼€æ”¾';
                } else if (p.status === 'ä¿®æ”¹å®¡æ‰¹ä¸­') {
                    nextStatus = 'å¼€æ”¾ä¸­';
                } else if (p.status === 'ä¸‹æ¶å®¡æ‰¹ä¸­') {
                    nextStatus = 'å·²ä¸‹æ¶';
                }

                p.status = nextStatus;
                this.showToast('Mock: é£ä¹¦å®¡æ‰¹é€šè¿‡', 'âœ…');
                
                if (['å·²ä¸Šæ¶å¾…å¼€æ”¾', 'å¼€æ”¾ä¸­'].includes(nextStatus)) {
                    if (this.checkAutoActive(p)) {
                        this.showToast('äº§å“è‡ªåŠ¨ä¸Šæ¶æˆåŠŸ', 'âš¡');
                    }
                }
                this.updateMonitorList();
            }
        }
    }).mount('#app');
</script>

<style>
    /* Utility */
    .form-group {
        @apply flex flex-col gap-2.5;
    }
    .label-std {
        @apply block text-xs font-bold text-gray-500;
    }
    .input-std {
        @apply w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-opay focus:ring-1 focus:ring-opay disabled:bg-gray-100 disabled:text-gray-500;
    }
</style>
</body>
</html>